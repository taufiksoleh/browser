name: Android Browser CI

on:
  push:
    branches: [ main, master, 'claude/**' ]
    paths:
      - 'android/**'
      - '.github/workflows/android-ci.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'android/**'
      - '.github/workflows/android-ci.yml'

env:
  BUILD_TYPE: Release

jobs:
  # ============================================================================
  # Code Quality Checks
  # ============================================================================
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle wrapper
        working-directory: android
        run: |
          # Download Gradle wrapper JAR if missing
          if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
            echo "Downloading Gradle wrapper JAR..."
            mkdir -p gradle/wrapper
            curl -L -o gradle/wrapper/gradle-wrapper.jar \
              https://raw.githubusercontent.com/gradle/gradle/master/gradle/wrapper/gradle-wrapper.jar
          fi

      - name: Grant execute permission for gradlew
        working-directory: android
        run: chmod +x gradlew

      - name: Check code quality
        working-directory: android
        run: |
          echo "========================================="
          echo "Running Code Quality Checks"
          echo "========================================="

          # Check for common issues in Java code
          echo ""
          echo "[Quality] Checking for common code issues..."

          if find app/src -name "*.java" -exec grep -l "System.out.println" {} \; 2>/dev/null | head -5; then
            echo "‚ö† WARNING: Found System.out.println statements (not blocking)"
          fi

          if find app/src -name "*.java" -exec grep -l "TODO\|FIXME" {} \; 2>/dev/null | head -5; then
            echo "‚ö† WARNING: Found TODO/FIXME comments (not blocking)"
          fi

          # Validate Android manifest
          echo ""
          echo "[Quality] Validating AndroidManifest.xml..."
          if [ -f "app/src/main/AndroidManifest.xml" ]; then
            echo "‚úì AndroidManifest.xml found"

            # Check for required permissions
            if grep -q "android.permission.INTERNET" app/src/main/AndroidManifest.xml; then
              echo "‚úì INTERNET permission declared"
            else
              echo "‚úó FAIL: INTERNET permission missing"
              exit 1
            fi
          else
            echo "‚úó FAIL: AndroidManifest.xml not found"
            exit 1
          fi

          echo ""
          echo "Code quality checks completed!"

      - name: Run Lint
        working-directory: android
        run: |
          ./gradlew lint --no-daemon
          echo "Lint analysis complete!"

      - name: Upload Lint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-results
          path: android/app/build/reports/lint-results*.html
          retention-days: 7

  # ============================================================================
  # Build Debug APK
  # ============================================================================
  build-debug:
    name: Build Debug APK
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle wrapper
        working-directory: android
        run: |
          # Download Gradle wrapper JAR if missing
          if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
            echo "Downloading Gradle wrapper JAR..."
            mkdir -p gradle/wrapper
            curl -L -o gradle/wrapper/gradle-wrapper.jar \
              https://raw.githubusercontent.com/gradle/gradle/master/gradle/wrapper/gradle-wrapper.jar
          fi

      - name: Grant execute permission for gradlew
        working-directory: android
        run: chmod +x gradlew

      - name: Build Debug APK
        working-directory: android
        run: |
          echo "========================================="
          echo "Building Debug APK"
          echo "========================================="
          ./gradlew assembleDebug --no-daemon --stacktrace

      - name: Verify Debug APK
        working-directory: android
        run: |
          echo "Verifying Debug APK..."
          APK_PATH="app/build/outputs/apk/debug/app-debug.apk"

          if [ -f "$APK_PATH" ]; then
            echo "‚úì Debug APK created successfully"
            ls -lh "$APK_PATH"

            # Get APK info
            echo ""
            echo "APK Information:"
            file "$APK_PATH"
            du -h "$APK_PATH"
          else
            echo "‚úó FAIL: Debug APK not found at $APK_PATH"
            echo "Contents of build/outputs/apk/debug:"
            ls -la app/build/outputs/apk/debug/ || echo "Directory not found"
            exit 1
          fi

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: browser-debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7

  # ============================================================================
  # Build Release APK
  # ============================================================================
  build-release:
    name: Build Release APK
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle wrapper
        working-directory: android
        run: |
          # Download Gradle wrapper JAR if missing
          if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
            echo "Downloading Gradle wrapper JAR..."
            mkdir -p gradle/wrapper
            curl -L -o gradle/wrapper/gradle-wrapper.jar \
              https://raw.githubusercontent.com/gradle/gradle/master/gradle/wrapper/gradle-wrapper.jar
          fi

      - name: Grant execute permission for gradlew
        working-directory: android
        run: chmod +x gradlew

      - name: Build Release APK
        working-directory: android
        run: |
          echo "========================================="
          echo "Building Release APK"
          echo "========================================="
          ./gradlew assembleRelease --no-daemon --stacktrace

      - name: Verify Release APK
        working-directory: android
        run: |
          echo "Verifying Release APK..."
          APK_PATH="app/build/outputs/apk/release/app-release-unsigned.apk"

          if [ -f "$APK_PATH" ]; then
            echo "‚úì Release APK created successfully"
            ls -lh "$APK_PATH"

            # Get APK info
            echo ""
            echo "APK Information:"
            file "$APK_PATH"
            du -h "$APK_PATH"

            # Show size comparison
            DEBUG_APK="app/build/outputs/apk/debug/app-debug.apk"
            if [ -f "$DEBUG_APK" ]; then
              echo ""
              echo "Size Comparison:"
              echo "Debug:   $(du -h "$DEBUG_APK" | cut -f1)"
              echo "Release: $(du -h "$APK_PATH" | cut -f1)"
            fi
          else
            echo "‚úó FAIL: Release APK not found at $APK_PATH"
            echo "Contents of build/outputs/apk/release:"
            ls -la app/build/outputs/apk/release/ || echo "Directory not found"
            exit 1
          fi

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: browser-release-apk
          path: android/app/build/outputs/apk/release/app-release-unsigned.apk
          retention-days: 30

  # ============================================================================
  # Unit Tests
  # ============================================================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle wrapper
        working-directory: android
        run: |
          # Download Gradle wrapper JAR if missing
          if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
            echo "Downloading Gradle wrapper JAR..."
            mkdir -p gradle/wrapper
            curl -L -o gradle/wrapper/gradle-wrapper.jar \
              https://raw.githubusercontent.com/gradle/gradle/master/gradle/wrapper/gradle-wrapper.jar
          fi

      - name: Grant execute permission for gradlew
        working-directory: android
        run: chmod +x gradlew

      - name: Run Unit Tests
        working-directory: android
        run: |
          echo "========================================="
          echo "Running Unit Tests"
          echo "========================================="
          ./gradlew test --no-daemon --stacktrace || echo "No tests found or tests failed (continuing)"

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            android/app/build/reports/tests/
            android/app/build/test-results/
          retention-days: 7

  # ============================================================================
  # Security Scan
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Security Checks
        working-directory: android
        run: |
          echo "========================================="
          echo "Running Security Checks"
          echo "========================================="

          # Check for hardcoded secrets
          echo ""
          echo "[Security] Checking for hardcoded secrets..."

          if find app/src -name "*.java" -exec grep -i "password\s*=\s*\"" {} \; 2>/dev/null | grep -v "example\|test"; then
            echo "‚ö† WARNING: Possible hardcoded password found"
          else
            echo "‚úì No hardcoded passwords found"
          fi

          if find app/src -name "*.java" -exec grep -i "api_key\s*=\s*\"" {} \; 2>/dev/null | grep -v "example\|test"; then
            echo "‚ö† WARNING: Possible hardcoded API key found"
          else
            echo "‚úì No hardcoded API keys found"
          fi

          # Check for debuggable in release
          echo ""
          echo "[Security] Checking AndroidManifest for security issues..."

          if grep -q "android:debuggable=\"true\"" app/src/main/AndroidManifest.xml 2>/dev/null; then
            echo "‚ö† WARNING: Debuggable flag found in manifest"
          else
            echo "‚úì No debuggable flag in manifest"
          fi

          if grep -q "usesCleartextTraffic=\"true\"" app/src/main/AndroidManifest.xml 2>/dev/null; then
            echo "‚Ñπ INFO: Cleartext traffic is allowed (may be intentional for development)"
          fi

          # Check for WebView security
          echo ""
          echo "[Security] Checking WebView security..."

          if find app/src -name "*.java" -exec grep -l "setJavaScriptEnabled(true)" {} \; 2>/dev/null; then
            echo "‚Ñπ INFO: JavaScript is enabled in WebView (expected for browser)"
          fi

          if find app/src -name "*.java" -exec grep -l "setAllowFileAccess\|setAllowContentAccess" {} \; 2>/dev/null; then
            echo "‚Ñπ INFO: File/Content access enabled in WebView (verify this is necessary)"
          fi

          echo ""
          echo "Security scan completed!"

  # ============================================================================
  # APK Analysis
  # ============================================================================
  analyze:
    name: APK Analysis
    runs-on: ubuntu-latest
    needs: [build-debug, build-release]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Debug APK
        uses: actions/download-artifact@v4
        with:
          name: browser-debug-apk
          path: apks/debug

      - name: Download Release APK
        uses: actions/download-artifact@v4
        with:
          name: browser-release-apk
          path: apks/release

      - name: Analyze APKs
        run: |
          echo "========================================="
          echo "APK Analysis"
          echo "========================================="

          echo ""
          echo "Debug APK:"
          ls -lh apks/debug/*.apk
          file apks/debug/*.apk

          echo ""
          echo "Release APK:"
          ls -lh apks/release/*.apk
          file apks/release/*.apk

          echo ""
          echo "Size Comparison:"
          DEBUG_SIZE=$(du -b apks/debug/*.apk | cut -f1)
          RELEASE_SIZE=$(du -b apks/release/*.apk | cut -f1)
          REDUCTION=$((100 - (RELEASE_SIZE * 100 / DEBUG_SIZE)))

          echo "Debug APK:   $(numfmt --to=iec-i --suffix=B $DEBUG_SIZE)"
          echo "Release APK: $(numfmt --to=iec-i --suffix=B $RELEASE_SIZE)"
          echo "Size reduction: ${REDUCTION}%"

  # ============================================================================
  # Final Status
  # ============================================================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [quality, build-debug, build-release, test, security, analyze]
    if: always()
    steps:
      - name: Check CI Status
        run: |
          echo "========================================="
          echo "CI Pipeline Summary"
          echo "========================================="
          echo ""
          echo "Quality:       ${{ needs.quality.result }}"
          echo "Build Debug:   ${{ needs.build-debug.result }}"
          echo "Build Release: ${{ needs.build-release.result }}"
          echo "Tests:         ${{ needs.test.result }}"
          echo "Security:      ${{ needs.security.result }}"
          echo "Analysis:      ${{ needs.analyze.result }}"
          echo ""

          if [ "${{ needs.quality.result }}" == "failure" ] || \
             [ "${{ needs.build-debug.result }}" == "failure" ] || \
             [ "${{ needs.build-release.result }}" == "failure" ]; then
            echo "‚ùå CI Pipeline FAILED"
            exit 1
          else
            echo "‚úÖ CI Pipeline PASSED"
            echo ""
            echo "üì¶ Artifacts available for download:"
            echo "  - browser-debug-apk (Debug APK for testing)"
            echo "  - browser-release-apk (Release APK - unsigned)"
          fi
